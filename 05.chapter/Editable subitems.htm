
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gbk" />
<link rel="stylesheet" href="../../templates/newpink/index.css"></link>
<link rel="alternate" type="application/rss+xml" title="ChinaUnix Blog RSS Feed" href="http://blog.chinaunix.net/u/rss.php?id=78338"></link>
<meta name="keywords" content="Editable subitems - vc学习 - HAYYP LIFE">
<meta name="description" content="中国最大的IT技术博客-ChinaUnix博客：Editable subitems - vc学习 - HAYYP LIFE">
<title>Editable subitems - vc学习 - HAYYP LIFE</title>
</head>
<body leftmargin=0 topmargin=0 marginwidth=0 marginheight=0 style="background:#FEE2EF;background-image:url()" align="center">

<center>
<table border="0" cellspacing="0" cellpadding="0" background="../../templates/newpink/images/bg_menu_top.gif" style="border-collapse: collapse;height:25" height="27" width="950" >
<tr> <td id="tool-bar" align="left" width="540" nowrap>
&nbsp;
<a href="http://blog.chinaunix.net/" target="_blank">博客首页</a>
<a href="http://blog.chinaunix.net/register.php" target="_blank">注册</a>
<a href="http://bbs.chinaunix.net/forumdisplay.php?fid=51" target="_blank">建议与交流</a> 
<a href="http://blog.chinaunix.net/top/" target="_blank">排行榜</a>
<a href="" target="_blank" onclick="NewWindows('http://www.cublog.cn/addlink.php?url='+location.href+'&title='+document.title);return false;">加入友情链接</a>

</td><form id="loginForm" method="get" target="_blank" action="/search.php">
<td align="right" nowrap>
<img src="/u2/userstar.php?blogid=78338" id="starimg" border=0 alt="" width=55 height=12>
<a href="/u2/star.php?blogid=78338" id="star" onclick="NewWindows(this.href);return false;" title="给此博客推荐值">推荐</a>
<a href="/u2/complaint.php?blogid=78338" id="complaint" onclick="NewWindows(this.href);return false;" title="投诉此博客">投诉</a>

 搜索：<input type="text" name="q" size="20"> <input type="image" src="../../templates/newpink/images/go.gif"> <a href="/help/" >帮助</a>&nbsp;</td>
</form></tr>
</table>
<script language="javascript">
<!--

navHover = function() {
var lis = document.getElementById("navmenu").getElementsByTagName("LI");
for (var i=0; i<lis.length; i++) {
lis[i].onmouseover=function() {
this.className+=" iehover";
}
lis[i].onmouseout=function() {
this.className=this.className.replace(new RegExp(" iehover\\b"), "");
}
}
}

function NewWindows(shref){
var xx=(window.screen.width-450)/2;
var yy=(window.screen.height-200)/2;
pp=window.open(shref,"win","menubar=no,location=no,resizable=no,scrollbars=no,status=no,left="+xx+",top="+yy+",Width=450,Height=200");
}
function $(s){return document.getElementById(s);}
//-->
</script>
<table border="0" cellspacing="0" cellpadding="0" height="143" style="border-collapse: collapse;background-image:url(http://www.cublog.cn/templates/newpink/images/bg_top.gif);background-repeat: no-repeat" width="950" bgcolor="#FEE8F1">
<tr><td align="center" width="300" >
<p style="line-height: 150%; margin: 5px">
 <font style="font-size:14px" 
 
 color="#FF0099">
 
<b>
 
 
 
 HAYYP LIFE 
 
 
</b>
 
 </font></p>
 </font></p>
 
</td><td width="650">
Be myself ！态度决定一切！</td></tr>

</table>

<table border="0" cellspacing="0" cellpadding="0" style="border-collapse: collapse" width="950" background="../../templates/newpink/images/bg_menu.gif" height="27"  bgcolor="#FFFFFF">

<tr></td><td width="250" align="center">
<a href="http://xiehuibo.cublog.cn" class="list1" style="color:#FF6699" target="_blank">xiehuibo.cublog.cn</a>
 
</td><td align="right" style="color:#2A5200" width="700">
<ul id="navmenu"><li class="ul0" style="width:60"><a href="http://control.cublog.cn/" target="_blank" class="list1">管理博客</a> </li>

<li class="ul0" style="width:60"><a href="http://control.cublog.cn/article_new.php" target="_blank" class="list1">发表文章</a></li>
<li class="ul0" style="width:40"><a href="guestbook.html" class="a1">留言</a></li>
<li class="ul0" style="width:50"><a href="links.html" class="list1">收藏夹</a>
<!-- 0 -->
</li>
<li class="ul0" style="width:50"><a href="group.html" class="list1">博客圈</a></li>
<li class="ul0" style="width:40"><a href="music.html" class="list1">音乐</a>
<!-- 0 -->
</li>
<li class="ul0" style="width:40"><a href="photo.html" class="list1">相册</a>
<!-- 0 -->
</li>
 
<li class="ul0" style="width:40"><a href="article.html" class="list1">文章</a>
<ul class="ul1"><li><a href="article_94402.html"> ・ 心情日志&nbsp;&nbsp;&nbsp;<font face='Wingdings 3'>}</font></a><ul class="ul2"><li><a href="article_140697.html"> ・ 工作学习<!-- a140697 --></a><!-- 140697 --></li>
<li><a href="article_96795.html"> ・ linux <!-- a96795 --></a><!-- 96795 --></li>
</ul>
</li>
<li><a href="article_96794.html"> ・ vc学习<!-- a96794 --></a><!-- 96794 --></li>
<li><a href="article_96796.html"> ・ linux<!-- a96796 --></a><!-- 96796 --></li>
<li><a href="article_97771.html"> ・ 智力测试<!-- a97771 --></a><!-- 97771 --></li>
</ul>

</li> 
<li class="ul0" style="width:40"><a href="index.html" class="list1">首页</a></li>
</ul>
</td>
<td width="4"></td>
</tr>
</table>
<script language="javascript">
<!--

function ShowHideDiv(divid,iImg){
if($(divid).style.display == "none"){
iImg.src="../../templates/newpink/images/dot2.gif";
$(divid).style.display = "block";
iImg.title="收起";
}else{
iImg.src="../../templates/newpink/images/dot4.gif";
$(divid).style.display = "none";
iImg.title="展开";
}
}
//navHover();
if (window.attachEvent) window.attachEvent("onload", navHover);
//-->
</script>
<table border="0" cellspacing="0" cellpadding="0" style="border-collapse: collapse" width="950" bgcolor="#FFFFFF">
<tr><td colspan="7" height="10"></td></tr>
<tr><td width="10"></td><td width="235" valign="top" align="center">
<table border="0" cellspacing="0" cellpadding="0" style="border-collapse: collapse;border: 1px solid #FED0E4; padding: 1;word-wrap:break-word;" width="224">
<tr><td background="../../templates/newpink/images/bg_line.gif" height="28" valign="top" align="center">
<table border="0" cellspacing="0" cellpadding="0" style="border-collapse: collapse;color:#FF0066" width="220" height="28">
<tr><td align="center" width="115"><b>关于作者</b></td>
<td width="105" align="right">
<img src="../../templates/newpink/images/dot2.gif" border="0" title="收起" onclick="ShowHideDiv('aboutwriter',this);return false;"/>&nbsp;</td>
</tr>
</table>
</td></tr>
<tr><td height="5"></td></tr>
<tr><td style="color:#FF6699" align="center">
<table border="0" cellspacing="0" cellpadding="0" style="border-collapse: collapse;word-wrap:break-word;color:#FF6699;" width="200" id="aboutwriter">
<tr><td align="center">
<a href="" target="_blank"><img src="up_user_pre.jpg" border=0 alt=""></a>
</td></tr>
<tr><td width="200">
<pre style="line-height: 150%; margin: 5px; " width="25">
姓名：
职业：student
年龄：
位置：
个性介绍：敢比会更重要
</pre>
</td></tr>
</table>
</td></tr>
<tr><td height="5"></td></tr>
</table>

<br />



<table border="0" cellspacing="0" cellpadding="0" style="border-collapse: collapse" bordercolor="#111111" width="220">

<table border="0" cellspacing="0" cellpadding="0" style="border-collapse: collapse;border: 1px solid #FED0E4; padding: 1" bgcolor="#FFFFFF" width="224">
<tr><td background="../../templates/newpink/images/bg_line.gif" height="28" valign="top" align="center">
<table border="0" cellspacing="0" cellpadding="0" style="border-collapse: collapse;color:#FF0066" width="220" height="28">
<tr><td align="center" width="115"><b>我的分类</b></td>
<td width="105" align="right">
<img src="../../templates/newpink/images/dot2.gif" border="0" title="收起" onclick="ShowHideDiv('lefttree',this);return false;"/>&nbsp;</td>
</tr>
</table>
</td></tr>
<tr><td height="5"></td></tr>
<tr><td>
<script src="../../templates/newpink/tree.js" ></script>
<div style="overflow:auto;scrollbar-face-color: #EEEEEE;scrollbar-highlight-color: #FFFFFF;scrollbar-shadow-color: #CCCCCC;scrollbar-3dlight-color: #D1D7DC;scrollbar-arrow-color:#006699;scrollbar-track-color: #CCCCCC;scrollbar-darkshadow-color: #EEDFE7;" id="lefttree"></div>
<script language="javascript">
ContentsTree = new CTree("ContentsTree");
ContentsTree.bAutoClose = false;
ContentsTree.stTarget = "";
a0 = ContentsTree.AddNode(null, "我的文章分类", "article.html");
a0.bOpen=true;
p0 = ContentsTree.AddNode(null, "我的图片分类", "photo.html");
p0.bOpen=true;
f0 = ContentsTree.AddNode(null, "我的链接分类", "links.html");
f0.bOpen=true;
m0 = ContentsTree.AddNode(null, "我的音乐分类", "music.html");
m0.bOpen=true;
a94402 = ContentsTree.AddNode(a0, "心情日志", "article_94402.html");
a140697 = ContentsTree.AddNode(a94402, "工作学习", "article_140697.html");
a96795 = ContentsTree.AddNode(a94402, "linux ", "article_96795.html");
a96794 = ContentsTree.AddNode(a0, "vc学习", "article_96794.html");
a96794.bOpen=true;
var pm=a96794;
while(pm=pm.pParent){
pm.bOpen=true;
}
a96796 = ContentsTree.AddNode(a0, "linux", "article_96796.html");
a97771 = ContentsTree.AddNode(a0, "智力测试", "article_97771.html");
 
 
 
 
//document.write(ContentsTree.GetHTMLCode());
document.getElementById("lefttree").innerHTML=ContentsTree.GetHTMLCode();
</script>	
</td></tr>
<tr><td height="5"></td></tr>
</table>

<br />
<a href="../rss.php?id=78338"><img src="../../templates/default/images/xmlrss.gif" border="0" alt="" /></a>

<br /><br />
</td><td width="10"></td><td valign="top" width="685">


<table border="0" cellspacing="0" cellpadding="0" style="border-collapse: collapse"  width="100%" align="center">

<tr><td bgcolor="#FED0E4" align="center">
<br />
<font color="#D52847" style="font-size:14pt"><b>Editable subitems</b></font>
</tr><tr><td>
<table border="1" cellspacing="1" cellpadding="0" style="border-collapse: collapse" bordercolor="#FED0E4" width="100%">
<tr><td align="center">

<table border="0" cellspacing="0" cellpadding="0" style="border-collapse: collapse;word-wrap:break-word;" width="100%">
<tr><td align="center">
<table border="0" cellspacing="0" cellpadding="0" style="border-collapse: collapse;word-wrap:break-word;"  width="100%">
<tr><td >
<div id="art"  style=" margin: 15px">
<DIV>Editable subitems<BR><B>Rating:</B> <FONT color=#990000><IMG height=12 src="http://www.codeguru.com/img/star.gif" width=13><IMG height=12 src="http://www.codeguru.com/img/star.gif" width=13><IMG height=12 src="http://www.codeguru.com/img/star.gif" width=13><IMG height=12 src="http://www.codeguru.com/img/star.gif" width=13><IMG height=12 src="http://www.codeguru.com/img/star-half.gif" width=13></FONT><BR><BR>
<TABLE cellSpacing=0 cellPadding=5 border=0>
<TBODY>
<TR>
<TD align=right></TD>
<TD class=bodycopy><B>Zafir Anjum</B> (<A href="http://www.codeguru.com/member.php/417/"><FONT color=#0000ff>view profile</FONT></A>)<BR>August 6, 1998 </TD></TR></TBODY></TABLE>
<P><SPAN class=bodycopy>
<P>
<HR width="100%">
The default implementation of the ListView control allows editing of the first column label only. You have to create your own edit control to allow editing of subitems. <BR><A href="http://www.codeguru.com/cpp/controls/listview/editingitemsandsubitem/article.php/c923/#more"><FONT color=#0000ff>(continued)</FONT></A> 
<P></P>
<DIV class=right_ads style="FLOAT: right; WIDTH: 336px"><!------ OAS AD 'flex' begin ------>
<SCRIPT language=JavaScript>
<!--
OAS_AD('flex');
//-->
</SCRIPT>
<NOSCRIPT></NOSCRIPT><!------ OAS AD 'flex' end ------><BR><BR><!------ OAS AD 'accessunit' begin ------>
<SCRIPT language=JavaScript>
<!--
OAS_AD('accessunit');
//-->
</SCRIPT>
<NOSCRIPT></NOSCRIPT><!------ OAS AD 'accessunit' end ------></DIV><A name=more>
<P><IMG height=78 src="http://www.codeguru.com/img/legacy/listview/edit_subitems.gif" width=276 border=1></P>
<H4>Step 1: Derive a class from CListCtrl</H4>In the code below, CMyListCtrl is the name used for the derived class. You can also derive a class from CListView if you need this functionality in a CView rather than in a control. If you are already working with a sub-class of CListCtrl, you can make the modifications to that class. 
<H4>Step 2: Define HitTestEx()</H4>Define an extended HitTest function for the CMyListCtrl class. This function will determine the row index that the point falls over and also determine the column. The HitTestEx() has already been listed and explained in an earlier section and is listed here again for completeness. We need this function if the user interface to initiate the edit is a mouse click or a double click. See the section "<A href="http://www.codeguru.com/cpp/controls/listview/editingitemsandsubitem/article.php/c923/col_index.shtml"><FONT color=#0000ff>Detecting column index of the item clicked</FONT></A>". <PRE><FONT color=#009900>// HitTestEx	- Determine the row index and column index <SPAN class=codeKeyword>for</SPAN> a point</FONT>
<FONT color=#009900>// Returns	- the row index or -1 <SPAN class=codeKeyword>if</SPAN> point <SPAN class=codeKeyword>is</SPAN> not over a row</FONT>
<FONT color=#009900>// point	- point to be tested.</FONT>
<FONT color=#009900>// col		- to hold the column index</FONT>
<FONT color=#0000ff><SPAN class=codeKeyword>int</SPAN></FONT> CMyListCtrl::HitTestEx(CPoint &amp;point, <FONT color=#0000ff><SPAN class=codeKeyword>int</SPAN></FONT> *col) <FONT color=#0000ff><SPAN class=codeKeyword>const</SPAN></FONT>
{
	<FONT color=#0000ff><SPAN class=codeKeyword>int</SPAN></FONT> colnum = 0;
	<FONT color=#0000ff><SPAN class=codeKeyword>int</SPAN></FONT> row = HitTest( point, <SPAN class=codeKeyword>NULL</SPAN> );

	<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT>( col ) *col = 0;

	<FONT color=#009900>// Make sure that the ListView <SPAN class=codeKeyword>is</SPAN> <SPAN class=codeKeyword>in</SPAN> LVS_REPORT</FONT>
	<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT>( (GetWindowLong(m_hWnd, GWL_STYLE) &amp; LVS_TYPEMASK) != LVS_REPORT )
		<FONT color=#0000ff><SPAN class=codeKeyword>return</SPAN></FONT> row;

	<FONT color=#009900>// Get the top and bottom row visible</FONT>
	row = GetTopIndex();
	<FONT color=#0000ff><SPAN class=codeKeyword>int</SPAN></FONT> bottom = row + GetCountPerPage();
	<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT>( bottom &gt; GetItemCount() )
		bottom = GetItemCount();

	<FONT color=#009900>// Get the number of columns</FONT>
	CHeaderCtrl* pHeader = (CHeaderCtrl*)GetDlgItem(0);
	<FONT color=#0000ff><SPAN class=codeKeyword>int</SPAN></FONT> nColumnCount = pHeader-&gt;GetItemCount();

	<FONT color=#009900>// Loop through the visible rows</FONT>
	<FONT color=#0000ff><SPAN class=codeKeyword>for</SPAN></FONT>( ;row &lt;=bottom;row++)
	{
		<FONT color=#009900>// Get bounding rect of item and check whether point falls <SPAN class=codeKeyword>in</SPAN> it.</FONT>
		CRect rect;
		GetItemRect( row, &amp;rect, LVIR_BOUNDS );
		<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT>( rect.PtInRect(point) )
		{
			<FONT color=#009900>// Now find the column</FONT>
			<FONT color=#0000ff><SPAN class=codeKeyword>for</SPAN></FONT>( colnum = 0; colnum &lt; nColumnCount; colnum++ )
			{
				<FONT color=#0000ff><SPAN class=codeKeyword>int</SPAN></FONT> colwidth = GetColumnWidth(colnum);
				<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT>( point.x &gt;= rect.left
					&amp;&amp; point.x &lt;= (rect.left + colwidth ) )
				{
					<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT>( col ) *col = colnum;
					<FONT color=#0000ff><SPAN class=codeKeyword>return</SPAN></FONT> row;
				}
				rect.left += colwidth;
			}
		}
	}
	<FONT color=#0000ff><SPAN class=codeKeyword>return</SPAN></FONT> -1;
}
</PRE>
<H4>Step 3: Add function to initiate the edit</H4>The user interface to initiate an edit for a sub item may be click on an already selected row, a double click or even a push button. We define a helper function to set up the edit control. The helper function takes only the row and column index of the subitem. EditSubLabel() ensures that the row as well as the column is visible before it creates the edit control. It then creates the edit control of the right size and with the proper text justification. The edit control created is of the class CInPlaceEdit which we will define later. <BR><PRE><FONT color=#009900>// EditSubLabel		- Start edit of a sub item label</FONT>
<FONT color=#009900>// Returns		- Temporary pointer to the <SPAN class=codeKeyword>new</SPAN> edit control</FONT>
<FONT color=#009900>// nItem		- The row index of the item to edit</FONT>
<FONT color=#009900>// nCol			- The column of the sub item.</FONT>
CEdit* CMyListCtrl::EditSubLabel( <FONT color=#0000ff><SPAN class=codeKeyword>int</SPAN></FONT> nItem, <FONT color=#0000ff><SPAN class=codeKeyword>int</SPAN></FONT> nCol )
{
	<FONT color=#009900>// The returned pointer should not be saved</FONT>

	<FONT color=#009900>// Make sure that the item <SPAN class=codeKeyword>is</SPAN> visible</FONT>
	<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT>( !EnsureVisible( nItem, TRUE ) ) <FONT color=#0000ff><SPAN class=codeKeyword>return</SPAN></FONT> <SPAN class=codeKeyword>NULL</SPAN>;

	<FONT color=#009900>// Make sure that nCol <SPAN class=codeKeyword>is</SPAN> valid</FONT>
	CHeaderCtrl* pHeader = (CHeaderCtrl*)GetDlgItem(0);
	<FONT color=#0000ff><SPAN class=codeKeyword>int</SPAN></FONT> nColumnCount = pHeader-&gt;GetItemCount();
	<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT>( nCol &gt;= nColumnCount || GetColumnWidth(nCol) &lt; 5 )
		<FONT color=#0000ff><SPAN class=codeKeyword>return</SPAN></FONT> <SPAN class=codeKeyword>NULL</SPAN>;

	<FONT color=#009900>// Get the column offset</FONT>
	<FONT color=#0000ff><SPAN class=codeKeyword>int</SPAN></FONT> offset = 0;
	<FONT color=#0000ff><SPAN class=codeKeyword>for</SPAN></FONT>( <FONT color=#0000ff><SPAN class=codeKeyword>int</SPAN></FONT> i = 0; i &lt; nCol; i++ )
		offset += GetColumnWidth( i );

	CRect rect;
	GetItemRect( nItem, &amp;rect, LVIR_BOUNDS );

	<FONT color=#009900>// Now scroll <SPAN class=codeKeyword>if</SPAN> we need to expose the column</FONT>
	CRect rcClient;
	GetClientRect( &amp;rcClient );
	<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT>( offset + rect.left &lt; 0 || offset + rect.left &gt; rcClient.right )
	{
		CSize size;
		size.cx = offset + rect.left;
		size.cy = 0;
		Scroll( size );
		rect.left -= size.cx;
	}

	<FONT color=#009900>// Get Column alignment</FONT>
	LV_COLUMN lvcol;
	lvcol.mask = LVCF_FMT;
	GetColumn( nCol, &amp;lvcol );
	DWORD dwStyle ;
	<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT>((lvcol.fmt&amp;LVCFMT_JUSTIFYMASK) == LVCFMT_LEFT)
		dwStyle = ES_LEFT;
	<FONT color=#0000ff><SPAN class=codeKeyword>else</SPAN></FONT> <FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT>((lvcol.fmt&amp;LVCFMT_JUSTIFYMASK) == LVCFMT_RIGHT)
		dwStyle = ES_RIGHT;
	<FONT color=#0000ff><SPAN class=codeKeyword>else</SPAN></FONT> dwStyle = ES_CENTER;

	rect.left += offset+4;
	rect.right = rect.left + GetColumnWidth( nCol ) - 3 ;
	<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT>( rect.right &gt; rcClient.right) rect.right = rcClient.right;

	dwStyle |= WS_BORDER|WS_CHILD|WS_VISIBLE|ES_AUTOHSCROLL;
	CEdit *pEdit = <FONT color=#0000ff><SPAN class=codeKeyword>new</SPAN></FONT> CInPlaceEdit(nItem, nCol, GetItemText( nItem, nCol ));
	pEdit-&gt;Create( dwStyle, rect, <FONT color=#0000ff><SPAN class=codeKeyword>this</SPAN></FONT>, IDC_IPEDIT );


	<FONT color=#0000ff><SPAN class=codeKeyword>return</SPAN></FONT> pEdit;
}</PRE>
<H4>Step 4: Handle the scroll messages</H4>The CInPlaceEdit class is designed to destroy the edit control and delete the object when it loses focus. Clicking on the scrollbars of the ListView control does not take away the focus from the edit control. We therefore add handlers for the scrollbar messages which force focus away from the edit control by setting the focus to the list view control itself. <BR><PRE><FONT color=#0000ff><SPAN class=codeKeyword>void</SPAN></FONT> CMyListCtrl::OnHScroll(UINT nSBCode, UINT nPos, CScrollBar* pScrollBar)
{
	<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT>( GetFocus() != <FONT color=#0000ff><SPAN class=codeKeyword>this</SPAN></FONT> ) SetFocus();
	CListCtrl::OnHScroll(nSBCode, nPos, pScrollBar);
}

<FONT color=#0000ff><SPAN class=codeKeyword>void</SPAN></FONT> CMyListCtrl::OnVScroll(UINT nSBCode, UINT nPos, CScrollBar* pScrollBar)
{
	<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT>( GetFocus() != <FONT color=#0000ff><SPAN class=codeKeyword>this</SPAN></FONT> ) SetFocus();
	CListCtrl::OnVScroll(nSBCode, nPos, pScrollBar);
}</PRE>
<H4>Step 5: Handle EndLabelEdit</H4>Like the built in edit control for the first column, our edit control also sends the LVN_ENDLABELEDIT notification when the edit is completed. If this notification message isnt already being handled, add a handler so that any changes made with the edit control can be accepted. <PRE><FONT color=#0000ff><SPAN class=codeKeyword>void</SPAN></FONT> CMyListCtrl::OnEndLabelEdit(NMHDR* pNMHDR, LRESULT* pResult)
{
	LV_DISPINFO *plvDispInfo = (LV_DISPINFO *)pNMHDR;
	LV_ITEM	*plvItem = &amp;plvDispInfo-&gt;item;

	<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT> (plvItem-&gt;pszText != <SPAN class=codeKeyword>NULL</SPAN>)
	{
		SetItemText(plvItem-&gt;iItem, plvItem-&gt;iSubItem, plvItem-&gt;pszText);
	}
	*pResult = FALSE;
}</PRE>
<H4>Step 6: Add means for the user to initiate the edit</H4>A suggested method for starting an edit of a subitem is to click on a subitem when the item already has the focus. You may choose to provide a different method. The code below is the handler for the WM_LBUTTONDOWN message. An edit control is created to edit a subitem if the subitem is clicked after the item already has the focus. The code checks for the LVS_EDITLABELS style before creating the edit control. It also does not activate the edit control for the first column since editing of the first column is already supported by the list view control. <BR><BR><PRE><FONT color=#0000ff><SPAN class=codeKeyword>void</SPAN></FONT> CMyListCtrl::OnLButtonDown(UINT nFlags, CPoint point)
{
	<FONT color=#0000ff><SPAN class=codeKeyword>int</SPAN></FONT> index;
	CListCtrl::OnLButtonDown(nFlags, point);

	<FONT color=#0000ff><SPAN class=codeKeyword>int</SPAN></FONT> colnum;
	<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT>( ( index = HitTestEx( point, &amp;colnum )) != -1 )
	{
		UINT flag = LVIS_FOCUSED;
		<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT>( (GetItemState( index, flag ) &amp; flag) == flag &amp;&amp; colnum &gt; 0)
		{
			<FONT color=#009900>// Add check <SPAN class=codeKeyword>for</SPAN> LVS_EDITLABELS</FONT>
			<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT>( GetWindowLong(m_hWnd, GWL_STYLE) &amp; LVS_EDITLABELS )
				EditSubLabel( index, colnum );
		}
		<FONT color=#0000ff><SPAN class=codeKeyword>else</SPAN></FONT>
			SetItemState( index, LVIS_SELECTED | LVIS_FOCUSED ,
				&nbsp;&nbsp;&nbsp;&nbsp;	LVIS_SELECTED | LVIS_FOCUSED);&nbsp;
	}
}</PRE>
<H4>Step 7: Subclass the CEdit class</H4>We need to subclass the CEdit class to provide for our special requirement. The main requirements placed on this class is that 
<UL>
<LI>It should send the LVN_ENDLABELEDIT message when edit is complete 
<LI>It should expand to accommodate the text 
<LI>It should destroy itself when the edit is complete 
<LI>The edit should be terminated when the user presses the Escape or the Enter key or when the edit control loses focus. </LI></UL>The listing of the header file precedes that of the implementation file. The CInPlaceEdit declares four private variables. These are used when the control sends the LVN_ENDLABELEDIT notification. <PRE><FONT color=#009900>// InPlaceEdit.h : header file</FONT>
<FONT color=#009900>//</FONT>

<FONT color=#009900>/////////////////////////////////////////////////////////////////////////////</FONT>
<FONT color=#009900>// CInPlaceEdit window</FONT>

<FONT color=#0000ff><SPAN class=codeKeyword>class</SPAN></FONT> CInPlaceEdit : <FONT color=#0000ff><SPAN class=codeKeyword>public</SPAN></FONT> CEdit
{
<FONT color=#009900>// Construction</FONT>
<FONT color=#0000ff><SPAN class=codeKeyword>public</SPAN></FONT>:
	CInPlaceEdit(<FONT color=#0000ff><SPAN class=codeKeyword>int</SPAN></FONT> iItem, <FONT color=#0000ff><SPAN class=codeKeyword>int</SPAN></FONT> iSubItem, CString sInitText);

<FONT color=#009900>// Attributes</FONT>
<FONT color=#0000ff><SPAN class=codeKeyword>public</SPAN></FONT>:

<FONT color=#009900>// Operations</FONT>
<FONT color=#0000ff><SPAN class=codeKeyword>public</SPAN></FONT>:

<FONT color=#009900>// Overrides</FONT>
	<FONT color=#009900>// ClassWizard generated <SPAN class=codeKeyword>virtual</SPAN> function overrides</FONT>
	<FONT color=#009900>//{{AFX_VIRTUAL(CInPlaceEdit)</FONT>
	<FONT color=#0000ff><SPAN class=codeKeyword>public</SPAN></FONT>:
	<FONT color=#0000ff><SPAN class=codeKeyword>virtual</SPAN></FONT> BOOL PreTranslateMessage(MSG* pMsg);
	<FONT color=#009900>//}}AFX_VIRTUAL</FONT>

<FONT color=#009900>// Implementation</FONT>
<FONT color=#0000ff><SPAN class=codeKeyword>public</SPAN></FONT>:
	<FONT color=#0000ff><SPAN class=codeKeyword>virtual</SPAN></FONT> ~CInPlaceEdit();

	<FONT color=#009900>// Generated message map functions</FONT>
<FONT color=#0000ff><SPAN class=codeKeyword>protected</SPAN></FONT>:
	<FONT color=#009900>//{{AFX_MSG(CInPlaceEdit)</FONT>
	afx_msg <FONT color=#0000ff><SPAN class=codeKeyword>void</SPAN></FONT> OnKillFocus(CWnd* pNewWnd);
	afx_msg <FONT color=#0000ff><SPAN class=codeKeyword>void</SPAN></FONT> OnNcDestroy();
	afx_msg <FONT color=#0000ff><SPAN class=codeKeyword>void</SPAN></FONT> OnChar(UINT nChar, UINT nRepCnt, UINT nFlags);
	afx_msg <FONT color=#0000ff><SPAN class=codeKeyword>int</SPAN></FONT> OnCreate(LPCREATESTRUCT lpCreateStruct);
	<FONT color=#009900>//}}AFX_MSG</FONT>

	DECLARE_MESSAGE_MAP()
<FONT color=#0000ff><SPAN class=codeKeyword>private</SPAN></FONT>:
	<FONT color=#0000ff><SPAN class=codeKeyword>int</SPAN></FONT> m_iItem;
	<FONT color=#0000ff><SPAN class=codeKeyword>int</SPAN></FONT> m_iSubItem;
	CString m_sInitText;
	BOOL&nbsp;&nbsp;&nbsp; m_bESC;	&nbsp;	<FONT color=#009900>// To indicate whether ESC key was pressed</FONT>
};

<FONT color=#009900>/////////////////////////////////////////////////////////////////////////////</TT></PRE< TT></PRE< TT></PRE< TT></PRE></TT><PRE></PRE></TT><PRE></PRE></TT><PRE></PRE></TT><PRE></PRE></TT><PRE></PRE></TT><PRE></PRE></FONT><PRE></PRE>The listing of the implementation file now follows. The CInPlaceEdit constructor simply saves the values passed through its arguments and initializes m_bESC to false. The overridden PreTranslateMessage() is to ascertain that certain key strokes do make it to the edit control. The escape key and the enter key are normally pre-translated by the CDialog or the CFormView object, we therefore specifically check for these and pass it on to the edit control. The check for GetKeyState( VK_CONTROL) makes sure that key combinations such as Ctrl-C, Ctrl-V and Ctrl-X get forwarded to the edit control. 
<P>OnKillFocus() sends of the LVN_ENDLABELEDIT notification and destroys the edit control. The notification is sent to the parent of the list view control and not to the list view control itself. When sending the notification, the m_bESC member variable is used to determine whether to send a NULL string. 
<P>The OnNcDestroy() function is the appropriate place to destroy the C++ object. 
<P>The OnChar() function ends the edit if the Escape or the Enter key is pressed. It does this by setting focus to the list view control which force the OnKillFocus() of the edit control to be called. For any other character, the OnChar() function lets the base class function take care of it before it tries to determine if the control needs to be resized. The function first gets the extent of the new string using the proper font and then compares it to the current dimension of the edit control. If the string is too long to fit within the edit control, it resizes the edit control after checking the parent window ( the list view control ) to determine if there is space for the edit control to grow. 
<P>The OnCreate() function creates the edit control and initializes it with the proper values. <BR><BR><PRE><FONT color=#009900>// InPlaceEdit.cpp : implementation file</FONT>
<FONT color=#009900>//</FONT>

<SPAN class=codeKeyword>#include</SPAN> "stdafx.h"
<SPAN class=codeKeyword>#include</SPAN> "InPlaceEdit.h"

#ifdef _DEBUG
<SPAN class=codeKeyword>#define</SPAN> <FONT color=#0000ff><SPAN class=codeKeyword>new</SPAN></FONT> DEBUG_NEW
#undef THIS_FILE
<FONT color=#0000ff><SPAN class=codeKeyword>static</SPAN></FONT> <FONT color=#0000ff><SPAN class=codeKeyword>char</SPAN></FONT> THIS_FILE[] = __FILE__;
#endif

<FONT color=#009900>/////////////////////////////////////////////////////////////////////////////</FONT>
<FONT color=#009900>// CInPlaceEdit</FONT>

CInPlaceEdit::CInPlaceEdit(<FONT color=#0000ff><SPAN class=codeKeyword>int</SPAN></FONT> iItem, <FONT color=#0000ff><SPAN class=codeKeyword>int</SPAN></FONT> iSubItem, CString sInitText)
:m_sInitText( sInitText )
{
	m_iItem = iItem;
	m_iSubItem = iSubItem;
	m_bESC = FALSE;
}

CInPlaceEdit::~CInPlaceEdit()
{
}


BEGIN_MESSAGE_MAP(CInPlaceEdit, CEdit)
	<FONT color=#009900>//{{AFX_MSG_MAP(CInPlaceEdit)</FONT>
	ON_WM_KILLFOCUS()
	ON_WM_NCDESTROY()
	ON_WM_CHAR()
	ON_WM_CREATE()
	<FONT color=#009900>//}}AFX_MSG_MAP</FONT>
END_MESSAGE_MAP()

<FONT color=#009900>/////////////////////////////////////////////////////////////////////////////</FONT>
<FONT color=#009900>// CInPlaceEdit message handlers</FONT>

BOOL CInPlaceEdit::PreTranslateMessage(MSG* pMsg)
{
	<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT>( pMsg-&gt;message == WM_KEYDOWN )
	{
		<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT>(pMsg-&gt;wParam == VK_RETURN
				|| pMsg-&gt;wParam == VK_DELETE
				|| pMsg-&gt;wParam == VK_ESCAPE
				|| GetKeyState( VK_CONTROL)
				)
		{
			::TranslateMessage(pMsg);
			::DispatchMessage(pMsg);
			<FONT color=#0000ff><SPAN class=codeKeyword>return</SPAN></FONT> TRUE;		&nbsp;&nbsp;&nbsp;&nbsp;	<FONT color=#009900>// DO NOT process further</FONT>
		}
	}

	<FONT color=#0000ff><SPAN class=codeKeyword>return</SPAN></FONT> CEdit::PreTranslateMessage(pMsg);
}


<FONT color=#0000ff><SPAN class=codeKeyword>void</SPAN></FONT> CInPlaceEdit::OnKillFocus(CWnd* pNewWnd)
{
	CEdit::OnKillFocus(pNewWnd);

	CString str;
	GetWindowText(str);

	<FONT color=#009900>// Send Notification to parent of ListView ctrl</FONT>
	LV_DISPINFO dispinfo;
	dispinfo.hdr.hwndFrom = GetParent()-&gt;m_hWnd;
	dispinfo.hdr.idFrom = GetDlgCtrlID();
	dispinfo.hdr.code = LVN_ENDLABELEDIT;

	dispinfo.item.mask = LVIF_TEXT;
	dispinfo.item.iItem = m_iItem;
	dispinfo.item.iSubItem = m_iSubItem;
	dispinfo.item.pszText = m_bESC ? <SPAN class=codeKeyword>NULL</SPAN> : LPTSTR((LPCTSTR)str);
	dispinfo.item.cchTextMax = str.GetLength();

	GetParent()-&gt;GetParent()-&gt;SendMessage( WM_NOTIFY, GetParent()-&gt;GetDlgCtrlID(),
					(LPARAM)&amp;dispinfo );

	DestroyWindow();
}

<FONT color=#0000ff><SPAN class=codeKeyword>void</SPAN></FONT> CInPlaceEdit::OnNcDestroy()
{
	CEdit::OnNcDestroy();

	<FONT color=#0000ff><SPAN class=codeKeyword>delete</SPAN></FONT> <FONT color=#0000ff><SPAN class=codeKeyword>this</SPAN></FONT>;
}


<FONT color=#0000ff><SPAN class=codeKeyword>void</SPAN></FONT> CInPlaceEdit::OnChar(UINT nChar, UINT nRepCnt, UINT nFlags)
{
	<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT>( nChar == VK_ESCAPE || nChar == VK_RETURN)
	{
		<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT>( nChar == VK_ESCAPE )
			m_bESC = TRUE;
		GetParent()-&gt;SetFocus();
		<FONT color=#0000ff><SPAN class=codeKeyword>return</SPAN></FONT>;
	}


	CEdit::OnChar(nChar, nRepCnt, nFlags);

	<FONT color=#009900>// Resize edit control <SPAN class=codeKeyword>if</SPAN> needed</FONT>

	<FONT color=#009900>// Get text extent</FONT>
	CString str;

	GetWindowText( str );
	CWindowDC dc(<FONT color=#0000ff><SPAN class=codeKeyword>this</SPAN></FONT>);
	CFont *pFont = GetParent()-&gt;GetFont();
	CFont *pFontDC = dc.SelectObject( pFont );
	CSize size = dc.GetTextExtent( str );
	dc.SelectObject( pFontDC );
	size.cx += 5;			&nbsp;&nbsp;&nbsp;	<FONT color=#009900>// add some extra buffer</FONT>

	<FONT color=#009900>// Get client rect</FONT>
	CRect rect, parentrect;
	GetClientRect( &amp;rect );
	GetParent()-&gt;GetClientRect( &amp;parentrect );

	<FONT color=#009900>// Transform rect to parent coordinates</FONT>
	ClientToScreen( &amp;rect );
	GetParent()-&gt;ScreenToClient( &amp;rect );

	<FONT color=#009900>// Check whether control needs to be resized</FONT>
	<FONT color=#009900>// and whether there <SPAN class=codeKeyword>is</SPAN> space to grow</FONT>
	<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT>( size.cx &gt; rect.Width() )
	{
		<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT>( size.cx + rect.left &lt; parentrect.right )
			rect.right = rect.left + size.cx;
		<FONT color=#0000ff><SPAN class=codeKeyword>else</SPAN></FONT>
			rect.right = parentrect.right;
		MoveWindow( &amp;rect );
	}
}

<FONT color=#0000ff><SPAN class=codeKeyword>int</SPAN></FONT> CInPlaceEdit::OnCreate(LPCREATESTRUCT lpCreateStruct)
{
	<FONT color=#0000ff><SPAN class=codeKeyword>if</SPAN></FONT> (CEdit::OnCreate(lpCreateStruct) == -1)
		<FONT color=#0000ff><SPAN class=codeKeyword>return</SPAN></FONT> -1;

	<FONT color=#009900>// Set the proper font</FONT>
	CFont* font = GetParent()-&gt;GetFont();
	SetFont(font);

	SetWindowText( m_sInitText );
	SetFocus();
	SetSel( 0, -1 );
	<FONT color=#0000ff><SPAN class=codeKeyword>return</SPAN></FONT> 0;
}</PRE></SPAN></DIV>
</div>
</td></tr>
</table>

<p style="line-height: 150%; margin: 5px">
 
 
</p>
</td></tr>
 
 
<tr><td height="25">
<font color="#D52847">&nbsp;发表于： 2008-11-13，修改于： 2008-11-13 22:21<br />
&nbsp;已浏览339次，有评论0条</font>
<a href="/u2/star.php?blogid=78338&artid=1413662" id="star" onclick="NewWindows(this.href);return false;" title="推荐这篇文章">推荐</a>
<a href="/u2/complaint.php?blogid=78338&artid=1413662" id="complaint" onclick="NewWindows(this.href);return false;" title="投诉这篇文章">投诉</a>

</td></tr>


</table>


</td></tr>
</table>


</td></tr>

</table>
<br />
<table border="1" cellspacing="0" cellpadding="0" style="border-collapse: collapse" bordercolor="#FED0E4" width="100%" align="center">
<tr><td background="../../templates/newpink/images/bg_line.gif" height="28">
&nbsp; <b>网友评论</b></td></tr>
<tr><td align="center">
<table border="0" cellspacing="0" cellpadding="0" style="border-collapse: collapse;color:#FF0066" width="100%">
 
</table>
</td></tr>
</table>
<br />


<table border="1" cellspacing="0" cellpadding="0" style="border-collapse: collapse" bordercolor="#FED0E4" width="100%" align="center">
<tr><td background="../../templates/newpink/images/bg_line.gif" height="28">&nbsp; <b>发表评论</b></td></tr>
<tr><td height="1" bgcolor="#FFFFFF"></td></tr>
<tr><td align="center" bgcolor="#FFFFFF" align="center">
 
<IFRAME NAME="comment" SRC="/comment/comment.php?bg=FFFFFF&ctype=0&iscomment=1&artid=1413662&blogid=78338" WIDTH="600" HEIGHT="160" frameborder="0"></IFRAME>
 

</td></tr>
</table>
<br /><br />

</td><td width="10"></td></tr>
</table>
<table border="0" cellspacing="0" cellpadding="0" style="border-collapse: collapse" width="950" align="center">
<tr><td height="50"></td></tr>
<tr><td align="center"> 
<br><p>Copyright &copy; 2001-2010 ChinaUnix.net   All Rights Reserved<br>
<p>感谢所有关心和支持过ChinaUnix的朋友们
<br />
页面生成时间：0.0138<p><a href=http://www.miibeian.gov.cn/ target=_blank>京ICP证041476号</a>
</td></tr>
</table>
</center>
<script language="javascript" src="http://stat.it168.com/pv.js"></script>
<script>
function sendPV(){
    var pvTrack = new PvTrack();
    pvTrack.type = 10; // 频道类别ID
    pvTrack.channel = 189; // 频道ID
   
    pvTrack.pageType = 0;
    pvTrack.track();
}
window.setTimeout("sendPV()", 0);
</script>
<script language="javascript" src="http://bbs.chinaunix.net/googlepv/pv.js" type="text/javascript"></script>
</html>

